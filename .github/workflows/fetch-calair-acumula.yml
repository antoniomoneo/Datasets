name: Fetch calair acumulado (yesterday)

on:
  schedule:
    - cron: "15 7 * * *"  # 07:15 UTC ≈ 09:15 CEST
    - cron: "15 8 * * *"  # 08:15 UTC ≈ 10:15 CEST
  workflow_dispatch:

jobs:
  fetch-accumulated-yesterday:
    timeout-minutes: 130
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      YEAR: ${{ steps.date.outputs.YEAR }}
      MONTH: ${{ steps.date.outputs.MONTH }}
      DAY: ${{ steps.date.outputs.DAY }}
    steps:
      - name: Checkout default branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          ref: main

      - name: Compute yesterday in Europe/Madrid
        id: date
        run: |
          python3 - <<'PY' >> "$GITHUB_OUTPUT"
          from datetime import datetime, timedelta
          from zoneinfo import ZoneInfo
          y = (datetime.now(ZoneInfo("Europe/Madrid")) - timedelta(days=1))
          print(f"YEAR={y:%Y}")
          print(f"MONTH={y:%m}")
          print(f"DAY={y:%d}")
          PY
      - name: Fetch ult JSON (pageSize=5000)
        run: |
          set -euo pipefail
          curl -sS -L -o ult.json 'https://ciudadesabiertas.madrid.es/dynamicAPI/API/query/calair_tiemporeal_ult.json?pageSize=5000'

      - name: Generate latest.flat.csv from ult (ayer)
        run: |
          set -euo pipefail
          python3 scripts/calair_ult_filter_to_csv.py --input ult.json

      - name: Clean temp JSON
        run: rm -f ult.json || true

      - name: Commit & push if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          if [ -n "$(git status --porcelain datasets/data/calair/latest.flat.csv)" ]; then
            git add datasets/data/calair/latest.flat.csv
            git commit -m "chore: calair ult ayer -> datasets/data/calair/latest.flat.csv [skip ci]"
            git push
          else
            echo "No changes to commit."
          fi
