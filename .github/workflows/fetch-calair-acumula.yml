name: Fetch calair acumulado (yesterday)

on:
  schedule:
    - cron: "15 7 * * *"  # 07:15 UTC ≈ 09:15 CEST
    - cron: "15 8 * * *"  # 08:15 UTC ≈ 10:15 CEST
  workflow_dispatch:

jobs:
  fetch-accumulated-yesterday:
    timeout-minutes: 130
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      YEAR: ${{ steps.date.outputs.YEAR }}
      MONTH: ${{ steps.date.outputs.MONTH }}
      DAY: ${{ steps.date.outputs.DAY }}
    steps:
      - name: Checkout default branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          ref: main

      - name: Compute yesterday in Europe/Madrid
        id: date
        run: |
          python3 - <<'PY' >> "$GITHUB_OUTPUT"
          from datetime import datetime, timedelta
          from zoneinfo import ZoneInfo
          y = (datetime.now(ZoneInfo("Europe/Madrid")) - timedelta(days=1))
          print(f"YEAR={y:%Y}")
          print(f"MONTH={y:%m}")
          print(f"DAY={y:%d}")
          PY

      - name: Fetch acumula JSON with retry
        run: |
          set -euo pipefail
          YEAR='${{ steps.date.outputs.YEAR }}'
          MONTH='${{ steps.date.outputs.MONTH }}'
          DAY='${{ steps.date.outputs.DAY }}'
          URL="https://datos.madrid.es/egob/catalogo/300755-12751602-calidad-aire-tiempo-real-acumula.json?MES=${MONTH}&ANO=${YEAR}&DIA=${DAY}"
          echo "Fetching: $URL"

          sudo apt-get update -y >/dev/null
          sudo apt-get install -y jq >/dev/null

          ok=0
          for attempt in 1 2 3 4 5 6 7 8 9 10 11 12; do
            code=$(curl -sS -w '%{http_code}' -L -o calair.json "$URL" || echo 000)
            if [ "$code" = "200" ] && [ -s calair.json ] && jq -e . calair.json >/dev/null 2>&1; then
              echo "OK on attempt $attempt"
              ok=1
              break
            fi
            echo "Not ready (code=$code). Retrying in 10 minutes..."
            sleep 600
          done

          if [ "$ok" != "1" ]; then
            echo "Data not available yet, failing job so it retries later." >&2
            exit 1
          fi

      - name: Generate latest.flat.csv
        run: |
          set -euo pipefail
          mkdir -p datasets/calidad-aire
          python3 - <<'PY'
          import json, csv
          from pathlib import Path
          # Load fetched JSON
          data = json.load(open('calair.json','r',encoding='utf-8'))
          rows = []
          if isinstance(data, dict):
            graph = data.get('@graph') or data.get('graph') or []
            if isinstance(graph, list):
              for station in graph:
                if not isinstance(station, dict):
                  continue
                station_id = station.get('@id','')
                title = station.get('title','')
                relation = station.get('relation','')
                measurements = station.get('medicion', [])
                if isinstance(measurements, list):
                  for m in measurements:
                    if not isinstance(m, dict):
                      continue
                    rows.append({
                      'station_id': station_id,
                      'title': title,
                      'relation': relation,
                      'magnitud': m.get('magnitud',''),
                      'valor': m.get('valor'),
                      'fecha': m.get('fecha',''),
                    })
          out = Path('datasets/calidad-aire/latest.flat.csv')
          if rows:
            fieldnames = list(rows[0].keys())
            with out.open('w',encoding='utf-8',newline='') as f:
              w = csv.DictWriter(f, fieldnames=fieldnames)
              w.writeheader(); w.writerows(rows)
          else:
            out.write_text('',encoding='utf-8')
          print(f'Wrote {len(rows)} rows to {out}')
          PY

      - name: Clean temp JSON
        run: rm -f calair.json || true

      - name: Commit & push if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          if [ -n "$(git status --porcelain datasets/calidad-aire/latest.flat.csv)" ]; then
            git add datasets/calidad-aire/latest.flat.csv
            git commit -m "chore: calair acumulado yesterday -> latest.flat.csv [skip ci]"
            git push
          else
            echo "No changes to commit."
          fi

  notify-failure:
    needs: fetch-accumulated-yesterday
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: Send failure email (if SMTP secrets configured)
        if: ${{ secrets.SMTP_SERVER != '' && secrets.SMTP_USERNAME != '' && secrets.SMTP_PASSWORD != '' && secrets.MAIL_FROM != '' && secrets.MAIL_TO != '' }}
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          from: ${{ secrets.MAIL_FROM }}
          to: ${{ secrets.MAIL_TO }}
          subject: "CALAIR acumulado NO disponible: ${{ needs.fetch-accumulated-yesterday.outputs.YEAR }}-${{ needs.fetch-accumulated-yesterday.outputs.MONTH }}-${{ needs.fetch-accumulated-yesterday.outputs.DAY }}"
          content_type: text/plain
          body: |
            No se pudo obtener el acumulado de calidad del aire.

            Fecha (ayer, Europe/Madrid): ${{ needs.fetch-accumulated-yesterday.outputs.DAY }}/${{ needs.fetch-accumulated-yesterday.outputs.MONTH }}/${{ needs.fetch-accumulated-yesterday.outputs.YEAR }}
            Endpoint: https://datos.madrid.es/egob/catalogo/300755-12751602-calidad-aire-tiempo-real-acumula.json?MES=${{ needs.fetch-accumulated-yesterday.outputs.MONTH }}&ANO=${{ needs.fetch-accumulated-yesterday.outputs.YEAR }}&DIA=${{ needs.fetch-accumulated-yesterday.outputs.DAY }}

            Workflow: ${{ github.workflow }}
            Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            Ref: ${{ github.ref_name }}

      - name: Missing SMTP secrets notice
        if: ${{ !(secrets.SMTP_SERVER != '' && secrets.SMTP_USERNAME != '' && secrets.SMTP_PASSWORD != '' && secrets.MAIL_FROM != '' && secrets.MAIL_TO != '') }}
        run: |
          echo "SMTP secrets not set. Configure repository secrets: SMTP_SERVER, SMTP_PORT, SMTP_USERNAME, SMTP_PASSWORD, MAIL_FROM, MAIL_TO" >&2
