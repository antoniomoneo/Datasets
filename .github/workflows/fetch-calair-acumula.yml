name: Fetch calair acumulado (yesterday)

on:
  schedule:
    - cron: "15 7 * * *"  # 07:15 UTC ≈ 09:15 CEST
    - cron: "15 8 * * *"  # 08:15 UTC ≈ 10:15 CEST
  workflow_dispatch:
    inputs:
      year:
        description: "Year (YYYY) to fetch; leave blank for yesterday"
        required: false
        default: ""
      month:
        description: "Month (MM) to fetch; leave blank for yesterday"
        required: false
        default: ""
      day:
        description: "Day (DD) to fetch; leave blank for yesterday"
        required: false
        default: ""

jobs:
  fetch-accumulated-yesterday:
    timeout-minutes: 130
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    outputs:
      YEAR: ${{ steps.date.outputs.YEAR }}
      MONTH: ${{ steps.date.outputs.MONTH }}
      DAY: ${{ steps.date.outputs.DAY }}
    steps:
      - name: Checkout default branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          ref: main

      - name: Compute target date in Europe/Madrid
        id: date
        env:
          INPUT_YEAR: ${{ github.event.inputs.year }}
          INPUT_MONTH: ${{ github.event.inputs.month }}
          INPUT_DAY: ${{ github.event.inputs.day }}
        run: |
          python3 - <<'PY' >> "$GITHUB_OUTPUT"
          from datetime import datetime, timedelta
          from zoneinfo import ZoneInfo
          import os

          manual_year = os.getenv("INPUT_YEAR") or ""
          manual_month = os.getenv("INPUT_MONTH") or ""
          manual_day = os.getenv("INPUT_DAY") or ""

          if manual_year and manual_month and manual_day:
              y = datetime.strptime(f"{manual_year}-{manual_month}-{manual_day}", "%Y-%m-%d")
          else:
              y = datetime.now(ZoneInfo("Europe/Madrid")) - timedelta(days=1)

          print(f"YEAR={y:%Y}")
          print(f"MONTH={y:%m}")
          print(f"DAY={y:%d}")
          PY
          
      - name: Fetch ult JSON (pageSize=5000)
        run: |
          set -euo pipefail
          curl -sS -L -o ult.json \
            "https://ciudadesabiertas.madrid.es/dynamicAPI/API/query/calair_tiemporeal_ult.json?pageSize=5000"

      - name: Generate latest.flat.csv from ult (ayer)
        run: |
          set -euo pipefail
          python3 scripts/calair_ult_filter_to_csv.py --input ult.json

      - name: Clean temp JSON
        run: |
          rm -f ult.json || true

      - name: Detect changes
        id: changes
        run: |
          set -euo pipefail
          if git diff --quiet -- data/calair/latest.flat.csv; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Create/update PR
        if: steps.changes.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: chore: calair ult ayer -> data/calair/latest.flat.csv [skip ci]
          title: chore: calair ult ${{ steps.date.outputs.YEAR }}-${{ steps.date.outputs.MONTH }}-${{ steps.date.outputs.DAY }}
          body: |
            Actualización automática de datos de calidad del aire para ${{ steps.date.outputs.YEAR }}-${{ steps.date.outputs.MONTH }}-${{ steps.date.outputs.DAY }}.
          branch: chore/calair-latest
          delete-branch: true
          add-paths: data/calair/latest.flat.csv
          committer: github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>
          author: github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>
